@using Refit
@inject I18n I18n
@inject IUserAPI API

@inject IStatusStorage<AuthState> AuthState
@inject IStatusStorage<ExceptionRequest> ExceptionRequest

@code {
    [Parameter]
    public long Id { get; set; }

    [CascadingParameter(Name = "loading")]
    public IStatusStorage<bool> Loading { get; set; } = null!;

    private string headerSrc = string.Empty;

    protected override void OnInitialized()
    {
        headerSrc = IUserAPI.GetHeader(Id) + $"?t={DateTime.UtcNow.Ticks}";
    }

    private async Task UploadAsync(InputFileChangeEventArgs e)
    {
        if (e.File.Size > 1024 * 1024 * 8)
        {
            ExceptionRequest.Value = new()
                {
                    Message = "File size must be less than 8MB",
                    StatusCode = System.Net.HttpStatusCode.BadRequest
                };
            return;
        }

        Loading.Value = true;

        await using var stream = e.File.OpenReadStream();
        StreamPart file = new(stream, e.File.Name, e.File.ContentType);
        var result = await API.UploadHeader(file);

        if (result.IsSuccessStatusCode == false)
            ExceptionRequest.Value = new()
                {
                    Message = "Failed to upload header",
                    StatusCode = result.StatusCode
                };

        Loading.Value = false;

        headerSrc = IUserAPI.GetHeader(Id) + $"?t={DateTime.UtcNow.Ticks}";
    }
}

<MImage Style="max-height: calc(15vh + 80px);" Src="@headerSrc" />

@if (AuthState.Value.Id == Id)
{
    <div class="edit-zone">
        <InputFile id="header" style="display: none;" accept="image/*" OnChange="UploadAsync" />
        <MButton Style="padding: 0%; display: flex;" Class="edit-button" Tile>
            <label for="header">@I18n.T("edit")</label>
        </MButton>

    </div>
}
<style>
    .edit-zone {
        position: absolute;
        top: 0;
        right: 0;
    }

    .edit-button {
        opacity: 0.5;
        transition: opacity 0.3s;
    }

    .edit-button:hover {
        opacity: 1;
    }

    .edit-button label {
        cursor: pointer;
        align-content: center;
        justify-content: center;
        width: 100%;
        height: 36px;
    }
</style>